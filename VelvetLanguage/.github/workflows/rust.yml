name: Velvet Test Suite

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always
  DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
  REPO: ${{ github.repository }}
  SHA: ${{ github.sha }}
  BRANCH: ${{ github.ref_name }}
  COMMIT_URL: https://github.com/${{ github.repository }}/commit/${{ github.sha }}
  ACTOR: ${{ github.actor }}
  EVENT_NAME: ${{ github.event_name }}
  PR_URL: ${{ github.event.pull_request.html_url }}

jobs:
  notify-start:
    permissions:
      contents: read
      pull-requests: read
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Start Notification
        run: |
          curl -H "Content-Type: application/json" \
          -X POST -d @- $DISCORD_WEBHOOK <<EOF
          {
            "embeds": [{
              "title": "🚀 Velvet CI Started",
              "color": 3447003,
              "fields": [
                { "name": "Actor", "value": "${{ env.ACTOR }}", "inline": true },
                { "name": "Branch", "value": "${{ env.BRANCH }}", "inline": true },
                { "name": "Commit", "value": "[View Commit](${{ env.COMMIT_URL }})" }
              ],
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }

  build-linux:
    permissions:
      contents: read
      pull-requests: read
    runs-on: ubuntu-latest
    needs: notify-start
    steps:
      - uses: actions/checkout@v4
      - name: Build
        run: cargo build --verbose
      - name: Run tests
        run: cargo test --verbose

  build-windows:
    permissions:
      contents: read
      pull-requests: read
    runs-on: windows-latest
    needs: notify-start
    steps:
      - uses: actions/checkout@v4
      - name: Build
        run: cargo build --verbose
      - name: Run tests
        run: cargo test --verbose

  build-macos:
    permissions:
      contents: read
      pull-requests: read
    runs-on: macos-latest
    needs: notify-start
    steps:
      - uses: actions/checkout@v4
      - name: Build
        run: cargo build --verbose
      - name: Run tests
        run: cargo test --verbose

  notify-complete:
    permissions:
      contents: read
      pull-requests: read
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, build-macos]
    if: ${{ always() }}
    steps:
      - name: Send Discord Success Notification
        if: ${{ success() }}
        run: |
          curl -H "Content-Type: application/json" \
          -X POST -d @- $DISCORD_WEBHOOK <<EOF
          {
            "embeds": [{
              "title": "✅ Velvet CI Succeeded",
              "color": 3066993,
              "fields": [
                { "name": "Actor", "value": "${{ env.ACTOR }}", "inline": true },
                { "name": "Branch", "value": "${{ env.BRANCH }}", "inline": true },
                { "name": "Commit", "value": "[View Commit](${{ env.COMMIT_URL }})" }
              ],
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }

      - name: Send Discord Failure Notification
        if: ${{ failure() }}
        run: |
          curl -H "Content-Type: application/json" \
          -X POST -d @- $DISCORD_WEBHOOK <<EOF
          {
            "embeds": [{
              "title": "❌ Velvet CI Failed",
              "color": 15158332,
              "fields": [
                { "name": "Actor", "value": "${{ env.ACTOR }}", "inline": true },
                { "name": "Branch", "value": "${{ env.BRANCH }}", "inline": true },
                { "name": "Commit", "value": "[View Commit](${{ env.COMMIT_URL }})" }
              ],
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
